@page "/open-packs/{SetId:int}/{SetName}"
@layout TcgFront.Layout.MainLayout  
@using TcgFront.Models.Dtos
@using TcgFront.Models.Dtos.Card
@using TcgFront.Services
@inject PackService PackService
@inject NavigationManager Navigation

<PageTitle>Abrir Sobres - @DecodeName(SetName)</PageTitle>

<div class="page-wrapper">

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading Packages...</p>
        </div>
    }
    else if (packages == null || !packages.Any())
    {
        <p class="error-msg">Packages not found</p>
    }
    else
    {
        <div class="packs-display-area">
            <div class="packs-container @(selectedPackId != null ? "has-selection" : "")">
                @for (int i = 0; i < packages.Count; i++)
                {
                    var pack = packages[i];
                    var isSelected = selectedPackId == pack.Id;
                    var rotation = (i - (packages.Count - 1) / 2.0) * 6;

                    <div class="pack-wrapper @(isSelected ? "is-selected" : "")"
                         style="--r:@(rotation.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture));">

                        <div class="real-pack" @onclick="() => SelectPack(pack.Id)">
                            <div class="foil-crimp top"></div>
                            <img src="@pack.ImageUrl" alt="@pack.Name" />
                            <div class="foil-crimp bottom"></div>
                            <div class="reflection"></div>

                            @if (isSelected)
                            {
                                <div class="pack-overlay-actions">
                                    <button class="btn-poke-small buy" @onclick:stopPropagation @onclick="() => ConfirmPurchase(pack.Id)">
                                        BUY
                                    </button>
                                    <button class="btn-poke-small cancel" @onclick:stopPropagation @onclick="DeselectPack">
                                        BACK
                                    </button>
                                </div>
                            }
                        </div>

                        @if (selectedPackId == null)
                        {
                            <div class="pack-info">
                                <span class="pack-name">@pack.Name</span>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="info-container">
            <div class="info-text">
                All packages contain the same content
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int SetId { get; set; }
    [Parameter] public string SetName { get; set; } = string.Empty;
    private int? selectedPackId = null;

    private List<PackageDto> packages = new();
    private bool isLoading = true;

    private string DecodeName(string encodedName) => Uri.UnescapeDataString(encodedName);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            packages = await PackService.GetPackDetails(SetId);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SelectPack(int packId)
    {
        if (selectedPackId == packId) return;
        selectedPackId = packId;
    }

    private void DeselectPack()
    {
        selectedPackId = null;
    }

    private void ConfirmPurchase(int packId)
    {
        Console.WriteLine($"Procesando compra de sobre: {packId}");
        DeselectPack();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }
}